There is a function, but it's a bit messy.
I've find all the bugs and check them. 
All corrections are writed in comments.
